{{ 'section-main-cart.css' | asset_url | stylesheet_tag }}
{{ 'component-cart.css' | asset_url | stylesheet_tag }}

<style>
  /* Only hide the specific date picker field in cart subtotal, not the whole aside */
  .cart__subtotal-widget input[type="date"]:not(#platter-date):not(#non-platter-date),
  .cart__subtotal-widget input[type="text"][name*="pickup"],
  .cart__subtotal-widget input[type="text"][name*="Pickup"],
  .cart__subtotal-widget input[type="text"][name*="delivery"],
  .cart__subtotal-widget input[type="text"][name*="Delivery"] {
    display: none !important;
  }
  
  /* Hide only the form field container that contains the unwanted date picker */
  .cart__subtotal-widget .form-field:has(input[type="date"]:not(#platter-date):not(#non-platter-date)),
  .cart__subtotal-widget .form-field:has(input[type="text"][name*="pickup"]),
  .cart__subtotal-widget .form-field:has(input[type="text"][name*="Pickup"]) {
    display: none !important;
  }
  
  /* Date and Time Picker Styling - Compact */
  datetime-slot-picker .datetime-slot-picker__field input[type="date"],
  datetime-slot-picker .datetime-slot-picker__field select {
    border: 2px solid #70a062 !important;
    color: #70a062 !important;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-size: calc(13px / 16 * var(--base-body-size) + 0px) !important;
  }
  
  /* Date input - 40% width with more spacing (desktop only) */
  datetime-slot-picker .datetime-slot-picker__field input[type="date"] {
    width: 100% !important;
    max-width: 100% !important;
    padding: 0.4rem 2rem 0.4rem 2.375rem !important;
    box-sizing: border-box !important;
  }
  
  /* Time select - 60% width with tighter padding (desktop only) */
  datetime-slot-picker .datetime-slot-picker__field select {
    max-width: 100% !important;
    width: 100% !important;
    padding: 0.4rem 2rem 0.4rem 2.125rem !important;
    box-sizing: border-box !important;
    font-weight: bold !important;
  }
  
  /* Prevent date input overflow */
  datetime-slot-picker .datetime-slot-picker__field {
    max-width: 100%;
    overflow: visible;
  }
  
  datetime-slot-picker.datetime-slot-picker--inline .datetime-slot-picker__fields {
    gap: 0.25rem !important;
  }
  
  /* Inline variant - date 40%, time 60% with more spacing (desktop only) */
  datetime-slot-picker.datetime-slot-picker--inline .datetime-slot-picker__field input[type="date"] {
    width: 100% !important;
    max-width: 100% !important;
    padding: 0.4rem 2rem 0.4rem 2.375rem !important;
    overflow: hidden;
    text-overflow: ellipsis;
    box-sizing: border-box !important;
  }
  
  datetime-slot-picker.datetime-slot-picker--inline .datetime-slot-picker__field select {
    max-width: 100% !important;
    width: 100% !important;
    padding: 0.4rem 2rem 0.4rem 2.125rem !important;
    overflow: hidden;
    text-overflow: ellipsis;
    box-sizing: border-box !important;
    font-weight: bold !important;
  }
  
  /* Ensure text color for date input value */
  datetime-slot-picker .datetime-slot-picker__field input[type="date"]::-webkit-datetime-edit-text,
  datetime-slot-picker .datetime-slot-picker__field input[type="date"]::-webkit-datetime-edit-month-field,
  datetime-slot-picker .datetime-slot-picker__field input[type="date"]::-webkit-datetime-edit-day-field,
  datetime-slot-picker .datetime-slot-picker__field input[type="date"]::-webkit-datetime-edit-year-field {
    color: #70a062 !important;
  }
  
  /* Ensure select option text color */
  datetime-slot-picker .datetime-slot-picker__field select option {
    color: #70a062 !important;
  }
</style>

<script>
  // Only hide the specific date picker field, not the whole aside
  (function() {
    function hidePickupDateField() {
      const subtotalWidget = document.querySelector('.cart__subtotal-widget');
      if (!subtotalWidget) {
        console.warn('Cart: subtotal widget not found');
        return;
      }
      
      // Find labels containing "When would you like"
      const labels = subtotalWidget.querySelectorAll('label');
      labels.forEach(function(label) {
        const labelText = label.textContent || '';
        if (labelText.toLowerCase().includes('when would you like to get this order') ||
            labelText.toLowerCase().includes('when would you like')) {
          // Hide only the label and its associated form field, not the whole widget
          const formField = label.closest('.form-field');
          if (formField) {
            formField.style.display = 'none';
          } else {
            // If no form-field, hide the label and find the next input
            label.style.display = 'none';
            const nextInput = label.nextElementSibling;
            if (nextInput && (nextInput.tagName === 'INPUT' || nextInput.tagName === 'SELECT')) {
              nextInput.style.display = 'none';
            }
          }
        }
      });
      
      // Hide any date inputs that aren't our datetime-slot-picker
      const dateInputs = subtotalWidget.querySelectorAll('input[type="date"]');
      dateInputs.forEach(function(input) {
        if (input.id !== 'platter-date' && input.id !== 'non-platter-date') {
          const formField = input.closest('.form-field');
          if (formField) {
            formField.style.display = 'none';
          } else {
            input.style.display = 'none';
          }
        }
      });
    }
    
    // Align "When would you like" section
    function alignWhenWouldYouLike() {
      const subtotalWidget = document.querySelector('.cart__subtotal-widget');
      if (!subtotalWidget) {
        console.warn('Cart: subtotal widget not found for alignment');
        return;
      }
      
      const labels = subtotalWidget.querySelectorAll('label');
      labels.forEach(function(label) {
        const labelText = label.textContent || '';
        if (labelText.toLowerCase().includes('when would you like to get this order') ||
            labelText.toLowerCase().includes('when would you like')) {
          const formField = label.closest('.form-field');
          if (formField) {
            // Desktop: align right, Mobile: center
            if (window.innerWidth > 767) {
              formField.style.textAlign = 'right';
            } else {
              formField.style.textAlign = 'center';
            }
          }
        }
      });
    }
    
    // Run immediately
    hidePickupDateField();
    alignWhenWouldYouLike();
    
    // Run on DOMContentLoaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        hidePickupDateField();
        alignWhenWouldYouLike();
      });
    } else {
      hidePickupDateField();
      alignWhenWouldYouLike();
    }
    
    // Watch for changes only in subtotal widget
    const observer = new MutationObserver(function() {
      hidePickupDateField();
      alignWhenWouldYouLike();
    });
    const subtotalWidget = document.querySelector('.cart__subtotal-widget');
    if (subtotalWidget) {
      observer.observe(subtotalWidget, { childList: true, subtree: true });
    }
    
    // Update alignment on window resize
    window.addEventListener('resize', alignWhenWouldYouLike);
  })();
</script>

<div class="container container--large container--vertical-space-small">
  <h1 class="title h2 gutter-bottom--page">{{ 'cart.title' | t }}</h1>
  <div class="cart-section {% if cart.items.size == 0 %} cart-section--empty {% endif %}">
    <main>
      {%- for block in section.blocks -%}
        {%- case block.type -%}
          {%- when '@app' -%}
            <div class="margin-bottom--regular" {{ block.shopify_attributes }}>
              {%- render block -%}
            </div>

          {%- when 'cart-items' -%}
            <div {{ block.shopify_attributes }}>
              {%- render 'cart-form-page' -%}
            </div>

          {%- when 'shipping-calculator' -%}
            <script src="{{ 'shopify_common.js' | shopify_asset_url }}" defer></script>
            <script src="{{ 'component-shipping-calculator.js' | asset_url }}" defer></script>
            {{ 'component-shipping-calculator.css' | asset_url | stylesheet_tag }}

            <shipping-calculator {{ block.shopify_attributes }}>
              <div class="shipping-calculator cart-block element--has-border--body element--border-radius margin-bottom--regular margin-top--regular">
                <div class="cart-block__head">
                  <span>{{ 'cart.shipping_calculator.title' | t }}</span>
                </div>

                <div class="shipping-calculator__content cart-block__content">
                  <div class="shipping-calculator__cell">
                    <label for="shipping-estimator-country">
                      {{- 'customers.addresses_page.form.country_label' | t -}}
                    </label>
                    <select
                      name="country"
                      id="shipping-estimator-country"
                      data-default="{{ customer.default_address.country | default: section.settings.shipping_estimator_default_country }}"
                      required
                    >
                      {{- country_option_tags -}}
                    </select>
                  </div>

                  <div class="shipping-calculator__cell" id="address_province_container" style="display: none">
                    <label for="shipping-estimator-province">
                      {{- 'customers.addresses_page.form.province_label' | t -}}
                    </label>
                    <select
                      name="province"
                      id="shipping-estimator-province"
                      data-default="{{ customer.default_address.province }}"
                    ></select>
                  </div>

                  <div class="shipping-calculator__cell">
                    <label for="shipping-estimator-zip">{{ 'customers.addresses_page.form.zip_label' | t }}</label>
                    <input
                      type="text"
                      name="zip"
                      id="shipping-estimator-zip"
                      class="form__field form__field--text"
                      value="{{ customer.default.address.zip }}"
                      required
                    >
                  </div>

                  <div class="shipping-calculator__cell">
                    <button
                      type="submit"
                      data-action="estimate-shipping"
                      class="button button--outline button--regular js-estimate-shipping"
                    >
                      {{ 'cart.shipping_calculator.form_button_label' | t }}
                    </button>
                  </div>
                </div>

                <div class="gutter--regular shipping-estimator__results" style="display: none;">
                  <div class="alert alert--error"></div>

                  <div class="shipping-estimator__results-content" style="display: none;">
                    <span class="shipping-estimator__results-content-heading text-size--regular"></span>
                    <ul class="shipping-estimator__results-content-list"></ul>
                  </div>
                </div>
              </div>
            </shipping-calculator>

          {%- when 'related-items' -%}
            <product-recommendations
              {{ block.shopify_attributes }}
              id="cart-recommendations"
              data-url="{{ routes.product_recommendations_url }}?section_id={{ section.id }}&product_id={{ cart.items[0].product_id }}&limit={{ block.settings.products_number }}"
            >
              {%- if recommendations.performed and recommendations.products_count > 0 -%}
                <div class="cart-product-recommendations">
                  <div class="cart-holder cart-block cart-block__item--spacing element--has-border--body element--border-radius margin-bottom--regular">
                    <div class="cart-block__head">
                      <span>{{ block.settings.title | escape }}</span>
                    </div>

                    {%- for product in recommendations.products -%}
                      <div class="product-related-item" data-js-product-item>
                        <a
                          href="{{ product.url }}"
                          class="product-related-item__image element--border-width-clamped element--border-radius"
                        >
                          {%- render 'lazy-image-small',
                            image: product.featured_media,
                            aspect_ratio: settings.cart_image_ratio,
                            fit: settings.cart_image_fit
                          -%}
                        </a>

                        <div class="product-related-item__text">
                          <a
                            class="product-related-item__title text-size--large text-weight--bold"
                            href="{{ product.url }}"
                          >
                            <span class="text-animation--underline-thin">{{ product.title | escape }}</span>
                          </a>
                          <span class="product-related-item__price">
                            {%- render 'product-price',
                              variant: product.selected_or_first_available_variant,
                              target: product.selected_or_first_available_variant,
                              product_price_varies: product.price_varies
                            -%}
                          </span>
                        </div>

                        <div class="product-related-item__button">
                          {%- render 'quick-buy', product: product, button_classes: 'button--small' -%}
                        </div>
                      </div>
                    {%- endfor -%}
                  </div>
                </div>
              {%- endif -%}
            </product-recommendations>
        {%- endcase -%}
      {%- endfor -%}
    </main>

    <aside>
      {%- render 'cart-subtotal', type: 'page' -%}
      {%- liquid
        assign has_platter = false
        for item in cart.items
          for tag in item.product.tags
            if tag == '2025 JP Christmas Platter'
              assign has_platter = true
              break
            endif
          endfor
          if has_platter
            break
          endif
        endfor
      -%}
    </aside>
  </div>
</div>

{% schema %}
{
  "name": "t:settings_schema.cart-page.name",
  "blocks": [
    {
      "type": "cart-items",
      "limit": 1,
      "name": "t:sections.main-cart-items.name"
    },
    {
      "type": "shipping-calculator",
      "limit": 1,
      "name": "t:sections.local-extra-words.sections.main-cart.blocks.shipping-calculator.name"
    },
    {
      "type": "related-items",
      "limit": 1,
      "name": "t:sections.local-extra-words.sections.main-product.blocks.related.name",
      "settings": [
        {
          "type": "paragraph",
          "content": "t:sections.local-extra-words.sections.main-cart.blocks.related-products.info"
        },
        {
          "type": "text",
          "id": "title",
          "label": "t:sections.local-extra-words.sections.headings.title",
          "default": "Related products"
        },
        {
          "type": "range",
          "id": "products_number",
          "label": "t:sections.featured-collection.settings.products_number.label",
          "min": 1,
          "max": 6,
          "step": 1,
          "default": 3
        }
      ]
    },
    {
      "type": "@app"
    }
  ],
  "settings": [
    {
      "type": "header",
      "content": "Wine Products Settings"
    },
    {
      "type": "checkbox",
      "id": "wine_warning_enable",
      "label": "Enable wine warning notice",
      "default": true,
      "info": "Show a legal drinking age warning when wine products are in the cart"
    },
    {
      "type": "text",
      "id": "wine_warning_title",
      "label": "Warning title",
      "default": "Legal Drinking Age Notice"
    },
    {
      "type": "textarea",
      "id": "wine_warning_text",
      "label": "Warning message",
      "default": "You must be of legal drinking age in your jurisdiction to purchase alcohol. By proceeding with checkout, you confirm that you are of legal drinking age."
    },
    {
      "type": "checkbox",
      "id": "wine_gift_enable",
      "label": "Enable gifting option checkbox",
      "default": true,
      "info": "Show a checkbox for customers to indicate if the wine purchase is a gift"
    },
    {
      "type": "text",
      "id": "wine_gift_text",
      "label": "Gift option label",
      "default": "This is a gift"
    }
  ]
}
{% endschema %}
