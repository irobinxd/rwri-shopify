{{ 'section-main-cart.css' | asset_url | stylesheet_tag }}
{{ 'component-cart.css' | asset_url | stylesheet_tag }}

<style>
  /* Only hide the specific date picker field in cart subtotal, not the whole aside */
  .cart__subtotal-widget input[type="date"]:not(#platter-date):not(#non-platter-date),
  .cart__subtotal-widget input[type="text"][name*="pickup"],
  .cart__subtotal-widget input[type="text"][name*="Pickup"],
  .cart__subtotal-widget input[type="text"][name*="delivery"],
  .cart__subtotal-widget input[type="text"][name*="Delivery"] {
    display: none !important;
  }
  
  /* Hide only the form field container that contains the unwanted date picker */
  .cart__subtotal-widget .form-field:has(input[type="date"]:not(#platter-date):not(#non-platter-date)),
  .cart__subtotal-widget .form-field:has(input[type="text"][name*="pickup"]),
  .cart__subtotal-widget .form-field:has(input[type="text"][name*="Pickup"]) {
    display: none !important;
  }
  
  /* Date and Time Picker Styling - Compact */
  datetime-slot-picker .datetime-slot-picker__field input[type="date"],
  datetime-slot-picker .datetime-slot-picker__field select {
    border: 2px solid #70a062 !important;
    color: #70a062 !important;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    font-size: calc(13px / 16 * var(--base-body-size) + 0px) !important;
  }
  
  /* Date input - 40% width with more spacing (desktop only) */
  datetime-slot-picker .datetime-slot-picker__field input[type="date"] {
    width: 100% !important;
    max-width: 100% !important;
    padding: 0.4rem 2rem 0.4rem 2.375rem !important;
    box-sizing: border-box !important;
  }
  
  /* Time select - 60% width with tighter padding (desktop only) */
  datetime-slot-picker .datetime-slot-picker__field select {
    max-width: 100% !important;
    width: 100% !important;
    padding: 0.4rem 2rem 0.4rem 2.125rem !important;
    box-sizing: border-box !important;
    font-weight: bold !important;
  }
  
  /* Prevent date input overflow */
  datetime-slot-picker .datetime-slot-picker__field {
    max-width: 100%;
    overflow: visible;
  }
  
  datetime-slot-picker.datetime-slot-picker--inline .datetime-slot-picker__fields {
    gap: 0.25rem !important;
  }
  
  /* Inline variant - date 40%, time 60% with more spacing (desktop only) */
  datetime-slot-picker.datetime-slot-picker--inline .datetime-slot-picker__field input[type="date"] {
    width: 100% !important;
    max-width: 100% !important;
    padding: 0.4rem 2rem 0.4rem 2.375rem !important;
    overflow: hidden;
    text-overflow: ellipsis;
    box-sizing: border-box !important;
  }
  
  datetime-slot-picker.datetime-slot-picker--inline .datetime-slot-picker__field select {
    max-width: 100% !important;
    width: 100% !important;
    padding: 0.4rem 2rem 0.4rem 2.125rem !important;
    overflow: hidden;
    text-overflow: ellipsis;
    box-sizing: border-box !important;
    font-weight: bold !important;
  }
  
  /* Ensure text color for date input value */
  datetime-slot-picker .datetime-slot-picker__field input[type="date"]::-webkit-datetime-edit-text,
  datetime-slot-picker .datetime-slot-picker__field input[type="date"]::-webkit-datetime-edit-month-field,
  datetime-slot-picker .datetime-slot-picker__field input[type="date"]::-webkit-datetime-edit-day-field,
  datetime-slot-picker .datetime-slot-picker__field input[type="date"]::-webkit-datetime-edit-year-field {
    color: #70a062 !important;
  }
  
  /* Ensure select option text color */
  datetime-slot-picker .datetime-slot-picker__field select option {
    color: #70a062 !important;
  }
  
  /* Multi-location warning styles */
  .cart-multi-location-warning {
    margin-bottom: var(--gutter-regular);
    padding: var(--gutter-regular);
    background-color: #fff3cd;
    border: 2px solid #ffc107;
    border-radius: var(--border-radius-cards);
  }
  
  .cart-multi-location-warning .warning-title {
    font-weight: bold;
    margin-bottom: 0.5rem;
    color: #856404;
    font-size: 1rem;
  }
  
  .cart-multi-location-warning .warning-message {
    color: #856404;
    font-size: 0.9rem;
    line-height: 1.5;
    margin-bottom: 0.75rem;
  }
  
  .cart-multi-location-warning .warning-locations {
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px solid rgba(133, 100, 4, 0.2);
  }
  
  .cart-multi-location-warning .location-group {
    margin-bottom: 0.75rem;
  }
  
  .cart-multi-location-warning .location-group:last-child {
    margin-bottom: 0;
  }
  
  .cart-multi-location-warning .location-group strong {
    display: block;
    margin-bottom: 0.5rem;
    color: #856404;
  }
  
  .cart-multi-location-warning .location-items {
    font-size: 0.85rem;
    padding-left: 1rem;
    color: #856404;
  }
  
  .cart-multi-location-warning .location-items li {
    margin-bottom: 0.25rem;
  }
</style>

<script>
  // Only hide the specific date picker field, not the whole aside
  (function() {
    function hidePickupDateField() {
      const subtotalWidget = document.querySelector('.cart__subtotal-widget');
      if (!subtotalWidget) {
        console.warn('Cart: subtotal widget not found');
        return;
      }
      
      // Find labels containing "When would you like"
      const labels = subtotalWidget.querySelectorAll('label');
      labels.forEach(function(label) {
        const labelText = label.textContent || '';
        if (labelText.toLowerCase().includes('when would you like to get this order') ||
            labelText.toLowerCase().includes('when would you like')) {
          // Hide only the label and its associated form field, not the whole widget
          const formField = label.closest('.form-field');
          if (formField) {
            formField.style.display = 'none';
          } else {
            // If no form-field, hide the label and find the next input
            label.style.display = 'none';
            const nextInput = label.nextElementSibling;
            if (nextInput && (nextInput.tagName === 'INPUT' || nextInput.tagName === 'SELECT')) {
              nextInput.style.display = 'none';
            }
          }
        }
      });
      
      // Hide any date inputs that aren't our datetime-slot-picker
      const dateInputs = subtotalWidget.querySelectorAll('input[type="date"]');
      dateInputs.forEach(function(input) {
        if (input.id !== 'platter-date' && input.id !== 'non-platter-date') {
          const formField = input.closest('.form-field');
          if (formField) {
            formField.style.display = 'none';
          } else {
            input.style.display = 'none';
          }
        }
      });
    }
    
    // Align "When would you like" section
    function alignWhenWouldYouLike() {
      const subtotalWidget = document.querySelector('.cart__subtotal-widget');
      if (!subtotalWidget) {
        console.warn('Cart: subtotal widget not found for alignment');
        return;
      }
      
      const labels = subtotalWidget.querySelectorAll('label');
      labels.forEach(function(label) {
        const labelText = label.textContent || '';
        if (labelText.toLowerCase().includes('when would you like to get this order') ||
            labelText.toLowerCase().includes('when would you like')) {
          const formField = label.closest('.form-field');
          if (formField) {
            // Desktop: align right, Mobile: center
            if (window.innerWidth > 767) {
              formField.style.textAlign = 'right';
            } else {
              formField.style.textAlign = 'center';
            }
          }
        }
      });
    }
    
    // Run immediately
    hidePickupDateField();
    alignWhenWouldYouLike();
    
    // Run on DOMContentLoaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        hidePickupDateField();
        alignWhenWouldYouLike();
      });
    } else {
      hidePickupDateField();
      alignWhenWouldYouLike();
    }
    
    // Watch for changes only in subtotal widget
    const observer = new MutationObserver(function() {
      hidePickupDateField();
      alignWhenWouldYouLike();
    });
    const subtotalWidget = document.querySelector('.cart__subtotal-widget');
    if (subtotalWidget) {
      observer.observe(subtotalWidget, { childList: true, subtree: true });
    }
    
    // Update alignment on window resize
    window.addEventListener('resize', alignWhenWouldYouLike);
  })();
  
  // Multi-location cart warning detection
  (function() {
    'use strict';
    
    // Enable/disable multi-location warning
    const ENABLE_MULTI_LOCATION_WARNING = false;
    
    // If disabled, exit early
    if (!ENABLE_MULTI_LOCATION_WARNING) {
      return;
    }
    
    // Store name patterns to identify locations
    const STORE_PATTERNS = {
      'jpp': ['proscenium', 'jpp', 'rockwell'],
      'jpa': ['alabang', 'jpa', 'makati']
    };
    
    // Normalize store name for matching
    function normalizeStoreName(storeName) {
      if (!storeName) return '';
      return storeName.toLowerCase().trim();
    }
    
    // Check if store name matches a location pattern
    function getLocationFromStoreName(storeName) {
      const normalized = normalizeStoreName(storeName);
      for (const [location, patterns] of Object.entries(STORE_PATTERNS)) {
        for (const pattern of patterns) {
          if (normalized.includes(pattern)) {
            return location.toUpperCase();
          }
        }
      }
      return null;
    }
    
    // Get store availability for a variant
    async function getVariantAvailability(variantId) {
      try {
        const baseUrl = window.Shopify?.routes?.root_url || '/';
        const url = `${baseUrl}variants/${variantId}/?section_id=helper-pickup-availability-compact`;
        
        const response = await fetch(url);
        if (!response.ok) return null;
        
        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // Find all availability alerts
        const availabilityAlerts = doc.querySelectorAll('.pickup-availability-alert');
        const locations = [];
        
        availabilityAlerts.forEach(alert => {
          const storeNameEl = alert.querySelector('.pickup-availability-alert-store');
          const isAvailable = alert.querySelector('.alert--success');
          
          if (storeNameEl && isAvailable) {
            const storeName = storeNameEl.textContent.trim();
            const location = getLocationFromStoreName(storeName);
            if (location) {
              locations.push({
                name: storeName,
                code: location
              });
            }
          }
        });
        
        return locations;
      } catch (error) {
        console.warn('Error fetching variant availability:', error);
        return null;
      }
    }
    
    // Check cart items for multi-location availability
    async function checkMultiLocationCart() {
      const cartForm = document.getElementById('AjaxCartForm');
      if (!cartForm) return;
      
      // Get cart data from API
      let cartData = null;
      try {
        const response = await fetch('/cart.js');
        if (response.ok) {
          cartData = await response.json();
        }
      } catch (error) {
        console.warn('Error fetching cart data:', error);
        return;
      }
      
      if (!cartData || !cartData.items || cartData.items.length < 2) {
        hideWarning();
        return;
      }
      
      // Get variant IDs from cart data
      const itemData = [];
      for (const cartItem of cartData.items) {
        if (cartItem.variant_id) {
          itemData.push({
            variantId: cartItem.variant_id,
            title: cartItem.product_title + (cartItem.variant_title && cartItem.variant_title !== 'Default Title' ? ' (' + cartItem.variant_title + ')' : ''),
            element: null
          });
        }
      }
      
      if (itemData.length < 2) {
        hideWarning();
        return;
      }
      
      // Check availability for each item
      const itemLocations = {};
      let allChecked = true;
      
      for (const item of itemData) {
        const locations = await getVariantAvailability(item.variantId);
        if (locations === null) {
          allChecked = false;
          break;
        }
        
        // Group items by location
        locations.forEach(loc => {
          if (!itemLocations[loc.code]) {
            itemLocations[loc.code] = {
              name: loc.name,
              items: []
            };
          }
          itemLocations[loc.code].items.push(item.title);
        });
      }
      
      if (!allChecked || Object.keys(itemLocations).length <= 1) {
        // Either couldn't check all items or all items are from same location(s)
        hideWarning();
        return;
      }
      
      // Check if items are exclusively from different locations
      const locationCodes = Object.keys(itemLocations);
      const exclusiveLocations = {};
      
      locationCodes.forEach(locCode => {
        const itemsInThisLocation = itemLocations[locCode].items;
        // Check if any item is ONLY in this location (not in others)
        itemsInThisLocation.forEach(itemTitle => {
          let isExclusive = true;
          locationCodes.forEach(otherLocCode => {
            if (otherLocCode !== locCode && itemLocations[otherLocCode].items.includes(itemTitle)) {
              isExclusive = false;
            }
          });
          
          if (isExclusive) {
            if (!exclusiveLocations[locCode]) {
              exclusiveLocations[locCode] = {
                name: itemLocations[locCode].name,
                items: []
              };
            }
            if (!exclusiveLocations[locCode].items.includes(itemTitle)) {
              exclusiveLocations[locCode].items.push(itemTitle);
            }
          }
        });
      });
      
      // Show warning if we have items exclusively from different locations
      if (Object.keys(exclusiveLocations).length > 1) {
        showWarning(exclusiveLocations);
      } else {
        hideWarning();
      }
    }
    
    // Show multi-location warning
    function showWarning(locationGroups) {
      let warningContainer = document.getElementById('cart-multi-location-warning');
      
      if (!warningContainer) {
        // Create warning container
        const cartForm = document.getElementById('AjaxCartForm');
        if (!cartForm) return;
        
        const cartHolder = cartForm.querySelector('.cart-holder');
        if (!cartHolder) return;
        
        warningContainer = document.createElement('div');
        warningContainer.id = 'cart-multi-location-warning';
        warningContainer.className = 'cart-multi-location-warning';
        cartHolder.insertBefore(warningContainer, cartHolder.firstChild);
      }
      
      // Build warning content
      const locationCodes = Object.keys(locationGroups);
      let locationsHTML = '<div class="warning-locations">';
      
      locationCodes.forEach(locCode => {
        const group = locationGroups[locCode];
        locationsHTML += `
          <div class="location-group">
            <strong>${group.name}:</strong>
            <ul class="location-items">
              ${group.items.map(item => `<li>${item}</li>`).join('')}
            </ul>
          </div>
        `;
      });
      
      locationsHTML += '</div>';
      
      warningContainer.innerHTML = `
        <div class="warning-title">⚠️ Items from Different Locations</div>
        <div class="warning-message">
          Your cart contains items that are only available at different branches. 
          Shopify requires all items to be available at a single pickup location. 
          You may need to place separate orders or remove items to proceed with checkout.
        </div>
        ${locationsHTML}
      `;
      
      warningContainer.style.display = 'block';
    }
    
    // Hide warning
    function hideWarning() {
      const warningContainer = document.getElementById('cart-multi-location-warning');
      if (warningContainer) {
        warningContainer.style.display = 'none';
      }
    }
    
    // Run check when cart loads or updates
    function initMultiLocationCheck() {
      // Wait a bit for cart to fully render
      setTimeout(() => {
        checkMultiLocationCart();
      }, 500);
    }
    
    // Run on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initMultiLocationCheck);
    } else {
      initMultiLocationCheck();
    }
    
    // Re-check when cart is updated
    document.addEventListener('cart-updated', function() {
      setTimeout(() => {
        checkMultiLocationCart();
      }, 1000);
    });
    
    // Also watch for cart form changes
    const cartForm = document.getElementById('AjaxCartForm');
    if (cartForm) {
      const observer = new MutationObserver(function() {
        setTimeout(() => {
          checkMultiLocationCart();
        }, 500);
      });
      
      observer.observe(cartForm, {
        childList: true,
        subtree: true
      });
    }
  })();
</script>

<div class="container container--large container--vertical-space-small">
  <h1 class="title h2 gutter-bottom--page">{{ 'cart.title' | t }}</h1>
  <div class="cart-section {% if cart.items.size == 0 %} cart-section--empty {% endif %}">
    <main>
      {%- for block in section.blocks -%}
        {%- case block.type -%}
          {%- when '@app' -%}
            <div class="margin-bottom--regular" {{ block.shopify_attributes }}>
              {%- render block -%}
            </div>

          {%- when 'cart-items' -%}
            <div {{ block.shopify_attributes }}>
              {%- render 'cart-form-page' -%}
            </div>

          {%- when 'shipping-calculator' -%}
            <script src="{{ 'shopify_common.js' | shopify_asset_url }}" defer></script>
            <script src="{{ 'component-shipping-calculator.js' | asset_url }}" defer></script>
            {{ 'component-shipping-calculator.css' | asset_url | stylesheet_tag }}

            <shipping-calculator {{ block.shopify_attributes }}>
              <div class="shipping-calculator cart-block element--has-border--body element--border-radius margin-bottom--regular margin-top--regular">
                <div class="cart-block__head">
                  <span>{{ 'cart.shipping_calculator.title' | t }}</span>
                </div>

                <div class="shipping-calculator__content cart-block__content">
                  <div class="shipping-calculator__cell">
                    <label for="shipping-estimator-country">
                      {{- 'customers.addresses_page.form.country_label' | t -}}
                    </label>
                    <select
                      name="country"
                      id="shipping-estimator-country"
                      data-default="{{ customer.default_address.country | default: section.settings.shipping_estimator_default_country }}"
                      required
                    >
                      {{- country_option_tags -}}
                    </select>
                  </div>

                  <div class="shipping-calculator__cell" id="address_province_container" style="display: none">
                    <label for="shipping-estimator-province">
                      {{- 'customers.addresses_page.form.province_label' | t -}}
                    </label>
                    <select
                      name="province"
                      id="shipping-estimator-province"
                      data-default="{{ customer.default_address.province }}"
                    ></select>
                  </div>

                  <div class="shipping-calculator__cell">
                    <label for="shipping-estimator-zip">{{ 'customers.addresses_page.form.zip_label' | t }}</label>
                    <input
                      type="text"
                      name="zip"
                      id="shipping-estimator-zip"
                      class="form__field form__field--text"
                      value="{{ customer.default.address.zip }}"
                      required
                    >
                  </div>

                  <div class="shipping-calculator__cell">
                    <button
                      type="submit"
                      data-action="estimate-shipping"
                      class="button button--outline button--regular js-estimate-shipping"
                    >
                      {{ 'cart.shipping_calculator.form_button_label' | t }}
                    </button>
                  </div>
                </div>

                <div class="gutter--regular shipping-estimator__results" style="display: none;">
                  <div class="alert alert--error"></div>

                  <div class="shipping-estimator__results-content" style="display: none;">
                    <span class="shipping-estimator__results-content-heading text-size--regular"></span>
                    <ul class="shipping-estimator__results-content-list"></ul>
                  </div>
                </div>
              </div>
            </shipping-calculator>

          {%- when 'related-items' -%}
            <product-recommendations
              {{ block.shopify_attributes }}
              id="cart-recommendations"
              data-url="{{ routes.product_recommendations_url }}?section_id={{ section.id }}&product_id={{ cart.items[0].product_id }}&limit={{ block.settings.products_number }}"
            >
              {%- if recommendations.performed and recommendations.products_count > 0 -%}
                <div class="cart-product-recommendations">
                  <div class="cart-holder cart-block cart-block__item--spacing element--has-border--body element--border-radius margin-bottom--regular">
                    <div class="cart-block__head">
                      <span>{{ block.settings.title | escape }}</span>
                    </div>

                    {%- for product in recommendations.products -%}
                      <div class="product-related-item" data-js-product-item>
                        <a
                          href="{{ product.url }}"
                          class="product-related-item__image element--border-width-clamped element--border-radius"
                        >
                          {%- render 'lazy-image-small',
                            image: product.featured_media,
                            aspect_ratio: settings.cart_image_ratio,
                            fit: settings.cart_image_fit
                          -%}
                        </a>

                        <div class="product-related-item__text">
                          <a
                            class="product-related-item__title text-size--large text-weight--bold"
                            href="{{ product.url }}"
                          >
                            <span class="text-animation--underline-thin">{{ product.title | escape }}</span>
                          </a>
                          <span class="product-related-item__price">
                            {%- render 'product-price',
                              variant: product.selected_or_first_available_variant,
                              target: product.selected_or_first_available_variant,
                              product_price_varies: product.price_varies
                            -%}
                          </span>
                        </div>

                        <div class="product-related-item__button">
                          {%- render 'quick-buy', product: product, button_classes: 'button--small' -%}
                        </div>
                      </div>
                    {%- endfor -%}
                  </div>
                </div>
              {%- endif -%}
            </product-recommendations>
        {%- endcase -%}
      {%- endfor -%}
    </main>

    <aside>
      {%- render 'cart-subtotal', type: 'page' -%}
      {%- liquid
        assign has_platter = false
        for item in cart.items
          for tag in item.product.tags
            if tag == '2025 JP Christmas Platter'
              assign has_platter = true
              break
            endif
          endfor
          if has_platter
            break
          endif
        endfor
      -%}
    </aside>
  </div>
</div>

{% schema %}
{
  "name": "t:settings_schema.cart-page.name",
  "blocks": [
    {
      "type": "cart-items",
      "limit": 1,
      "name": "t:sections.main-cart-items.name"
    },
    {
      "type": "shipping-calculator",
      "limit": 1,
      "name": "t:sections.local-extra-words.sections.main-cart.blocks.shipping-calculator.name"
    },
    {
      "type": "related-items",
      "limit": 1,
      "name": "t:sections.local-extra-words.sections.main-product.blocks.related.name",
      "settings": [
        {
          "type": "paragraph",
          "content": "t:sections.local-extra-words.sections.main-cart.blocks.related-products.info"
        },
        {
          "type": "text",
          "id": "title",
          "label": "t:sections.local-extra-words.sections.headings.title",
          "default": "Related products"
        },
        {
          "type": "range",
          "id": "products_number",
          "label": "t:sections.featured-collection.settings.products_number.label",
          "min": 1,
          "max": 6,
          "step": 1,
          "default": 3
        }
      ]
    },
    {
      "type": "@app"
    }
  ],
  "settings": [
    {
      "type": "header",
      "content": "Wine Products Settings"
    },
    {
      "type": "checkbox",
      "id": "wine_warning_enable",
      "label": "Enable wine warning notice",
      "default": true,
      "info": "Show a legal drinking age warning when wine products are in the cart"
    },
    {
      "type": "text",
      "id": "wine_warning_title",
      "label": "Warning title",
      "default": "Legal Drinking Age Notice"
    },
    {
      "type": "textarea",
      "id": "wine_warning_text",
      "label": "Warning message",
      "default": "You must be of legal drinking age in your jurisdiction to purchase alcohol. By proceeding with checkout, you confirm that you are of legal drinking age."
    },
    {
      "type": "checkbox",
      "id": "wine_gift_enable",
      "label": "Enable gifting option checkbox",
      "default": true,
      "info": "Show a checkbox for customers to indicate if the wine purchase is a gift"
    },
    {
      "type": "text",
      "id": "wine_gift_text",
      "label": "Gift option label",
      "default": "This is a gift"
    }
  ]
}
{% endschema %}
