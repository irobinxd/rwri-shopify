{%- comment -%}
  Gets Shopify store locations dynamically
  This snippet collects ALL locations that have pickup enabled from products
  Checks multiple products to ensure all locations are captured, even if they don't have inventory
{%- endcomment -%}

{%- liquid
  assign locations_map = ''
  assign location_handles = ''
  assign products_checked = 0
  assign max_products_to_check = 50
  
  if collections.all.products.size > 0
    for product in collections.all.products limit: max_products_to_check
      assign variant = product.selected_or_first_available_variant
      if variant
        assign pick_up_availabilities = variant.store_availabilities | where: 'pick_up_enabled', true
        if pick_up_availabilities.size > 0
          for availability in pick_up_availabilities
            assign location_name = availability.location.name
            assign location_handle = location_name | handleize
            
            assign check_handle = '||' | append: location_handle | append: '||'
            assign check_handles = '||' | append: location_handles | append: '||'
            
            unless check_handles contains check_handle
              if location_handles == blank
                assign location_handles = location_handle
                assign locations_map = location_name | append: '::' | append: location_handle
              else
                assign location_handles = location_handles | append: '||' | append: location_handle
                assign locations_map = locations_map | append: '||' | append: location_name | append: '::' | append: location_handle
              endif
            endunless
          endfor
          assign products_checked = products_checked | plus: 1
        endif
      endif
    endfor
  endif
-%}

{%- comment -%} Output locations as JSON for JavaScript {%- endcomment -%}
<script type="application/json" id="shopify-locations-data">
[
  {%- if locations_map != blank -%}
    {%- assign locations_array = locations_map | split: '||' -%}
    {%- for location_string in locations_array -%}
      {%- assign location_parts = location_string | split: '::' -%}
      {
        "name": {{ location_parts[0] | json }},
        "handle": {{ location_parts[1] | json }}
      }{%- unless forloop.last -%},{%- endunless -%}
    {%- endfor -%}
  {%- endif -%}
]
</script>

