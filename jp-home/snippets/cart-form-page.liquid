{% comment %}
  Renders cart form (page version).

  Usage:
  {% render 'cart-form-page' %}
{% endcomment %}

<cart-form id="AjaxCartForm">
	
  {%- liquid
    if settings.show_currency_codes
      assign iso_code = localization.country.currency.iso_code | prepend: ' ' 
    endif
  -%}

	<form action="{{ routes.cart_url }}" method="post" novalidate class="cart__form {% if cart.item_count == 0 %} cart--empty {% endif %}" id="cart">
		{%- comment -%} Hidden inputs for date/time attributes to be saved to order {%- endcomment -%}
		<input type="hidden" name="attributes[Pre-Orders Pickup Date]" id="platter-datetime-attr" value="">
		<input type="hidden" name="attributes[Click and Collect Pickup Date]" id="non-platter-datetime-attr" value="">
	
		{%- liquid
			assign has_platter = false
			assign has_non_platter = false
			
			for item in cart.items
				assign is_platter_item = false
				for tag in item.product.tags
					if tag == '2025 JP Christmas Platter'
						assign is_platter_item = true
						break
					endif
				endfor
				
				if is_platter_item
					assign has_platter = true
				else
					assign has_non_platter = true
				endif
			endfor
		-%}

		<div class="cart-holder cart-block {% unless has_platter or has_non_platter %}element--has-border--body element--border-radius{% endunless %} element--no-border-on-small margin-bottom--regular" data-items="{{ cart.items.size }}">

			<div class="cart-form__items {% if cart.item_count == 0 %} gutter--regular {% endif %}">
				{%- if cart.item_count > 0 -%}
					
					{%- if has_platter -%}
						{%- comment -%}
						  Timeslot Configuration for Pre-Orders (Platters)
						  - Default: 10:00 AM to 8:00 PM, 30-min slots
						  - dateOverrides: Different hours for specific dates (format: "YYYY-MM-DD")
						    - startHour: 10 = 10am, 12 = 12pm, etc.
						    - endHour: 20 = 8pm, 18 = 6pm, etc.
						  - closedDates: Dates when store is closed (no pickup available)
						  
						  December 2025 Schedule:
						  - Dec 15-23: 10am (default)
						  - Dec 24 & 31: 10am (default)  
						  - Dec 25 & Jan 1: 12pm start
						  - Jan 2 onwards: 10am (default)
						{%- endcomment -%}
						{%- capture platter_timeslot_config -%}
						{
							"startHour": 10,
							"endHour": 20,
							"slotDuration": 30,
							"closedDates": [],
							"dateOverrides": {
								"2025-12-25": { "startHour": 12, "endHour": 20 },
								"2025-12-31": { "startHour": 10, "endHour": 17 },
								"2026-01-01": { "startHour": 12, "endHour": 20 }
							}
						}
						{%- endcapture -%}
						<div class="cart-items-group">
							<div class="cart-items-group__header">
								<span>Pre-Orders</span>
								<datetime-slot-picker data-is-platter="true" data-lead-days="3" data-available-days="10" data-timeslot-config='{{ platter_timeslot_config | strip_newlines }}' class="datetime-slot-picker--inline">
									<div class="datetime-slot-picker__fields">
										<div class="datetime-slot-picker__field">
											<label for="platter-date" class="visually-hidden">Date</label>
											<input type="date" id="platter-date" name="platter-date" required>
										</div>
										<div class="datetime-slot-picker__field">
											<label for="platter-time" class="visually-hidden">Time</label>
											<select id="platter-time" name="platter-time" required>
												
											</select>
										</div>
									</div>
								</datetime-slot-picker>
							</div>
							<div class="cart-block__head element--hide-on-small">
								<span>{{ 'cart.table.product' | t }}</span>
								<span>{{ 'cart.table.quantity' | t }}</span>
								<span class="text-align--right">{{ 'cart.table.total' | t }}</span>
							</div>
							{%- for item in cart.items -%}
								{%- liquid
									assign is_platter = false
									for tag in item.product.tags
										if tag == '2025 JP Christmas Platter'
											assign is_platter = true
											break
										endif
									endfor
								-%}
								{%- if is_platter -%}
									{%- render 'cart-form-item', item: item, iso_code: iso_code, line: forloop.index -%}
								{%- endif -%}
							{%- endfor -%}
						</div>
					{%- endif -%}

					{%- if has_non_platter -%}
						{%- comment -%}
						  Timeslot Configuration for Click and Collect
						  - Default: 10:00 AM to 8:00 PM, 30-min slots
						  - dateOverrides: Different hours for specific dates (format: "YYYY-MM-DD")
						  - closedDates: Dates when store is closed (no pickup available)
						  
						  December 2025 Schedule:
						  - Dec 15-23: 10am (default)
						  - Dec 24 & 31: 10am (default)  
						  - Dec 25 & Jan 1: 12pm start
						  - Jan 2 onwards: 10am (default)
						{%- endcomment -%}
						{%- capture collect_timeslot_config -%}
						{
							"startHour": 10,
							"endHour": 20,
							"slotDuration": 30,
							"closedDates": [],
							"dateOverrides": {
								"2025-12-25": { "startHour": 12, "endHour": 20 },
								"2025-12-31": { "startHour": 10, "endHour": 17 },
								"2026-01-01": { "startHour": 12, "endHour": 20 }
							}
						}
						{%- endcapture -%}
						<div class="cart-items-group">
							<div class="cart-items-group__header">
								<span>Click and Collect</span>
								<datetime-slot-picker data-is-platter="false" data-lead-days="0" data-timeslot-config='{{ collect_timeslot_config | strip_newlines }}' class="datetime-slot-picker--inline">
									<div class="datetime-slot-picker__fields">
										<div class="datetime-slot-picker__field">
											<label for="non-platter-date" class="visually-hidden">Date</label>
											<input type="date" id="non-platter-date" name="non-platter-date" required>
										</div>
										<div class="datetime-slot-picker__field">
											<label for="non-platter-time" class="visually-hidden">Time</label>
											<select id="non-platter-time" name="non-platter-time" required>
												
											</select>
										</div>
									</div>
								</datetime-slot-picker>
							</div>
							<div class="cart-block__head element--hide-on-small">
								<span>{{ 'cart.table.product' | t }}</span>
								<span>{{ 'cart.table.quantity' | t }}</span>
								<span class="text-align--right">{{ 'cart.table.total' | t }}</span>
							</div>
							{%- for item in cart.items -%}
								{%- liquid
									assign is_platter = false
									for tag in item.product.tags
										if tag == '2025 JP Christmas Platter'
											assign is_platter = true
											break
										endif
									endfor
								-%}
								{%- unless is_platter -%}
									{%- render 'cart-form-item', item: item, iso_code: iso_code, line: forloop.index -%}
								{%- endunless -%}
							{%- endfor -%}
						</div>
					{%- endif -%}

					{%- unless has_platter or has_non_platter -%}
						<div class="cart-block__head element--hide-on-small">
							<span>{{ 'cart.table.product' | t }}</span>
							<span>{{ 'cart.table.quantity' | t }}</span>
							<span class="text-align--right">{{ 'cart.table.total' | t }}</span>
						</div>
						{%- for item in cart.items -%}
							{%- render 'cart-form-item', item: item, iso_code: iso_code, line: forloop.index -%}
						{%- endfor -%}
					{%- endunless -%}

				{%- else -%}

					{{ 'cart.empty' | t }}
					<div class="gutter-top--regular">
						<a href="{{ routes.all_products_collection_url }}" class="button button--solid button--large">
							{{ 'cart.continue_browsing' | t }}
						</a>
					</div>

				{%- endif -%}

			</div>

		</div>

	</form>

	<span class="cart__count hidden" aria-hidden="true" data-cart-count>{{ cart.item_count }}</span>
	<span class="cart__total hidden" aria-hidden="true" data-cart-total>{{ cart.total_price | money | append: iso_code }}</span>

</cart-form>

{%- render 'cart-gift-wrapping', class: 'cart-wrapping--page' -%}

<noscript>
	<button type="submit" class="button button--outline button--regular" form="cart">
		{{ 'cart.update' | t }}
	</button>
</noscript>

<script src="{{ 'component-datetime-slot-picker.js' | asset_url }}" defer></script>

<script type="text/javascript">
	document.querySelector('cart-form').addEventListener('cart-updated', ()=>{
		const items = parseInt(document.querySelector('.cart-holder').getAttribute('data-items'));
		if ( items == 0 ) {
			document.querySelector('.cart-section').classList.add('cart-section--empty');
		} else {
			document.querySelector('.cart-section').classList.remove('cart-section--empty');
		}
	});

	// Format date and time for display
	function formatDateTime(dateValue, timeValue) {
		if (!dateValue || !timeValue) return null;
		
		const dateObj = new Date(dateValue + 'T00:00:00');
		const formattedDate = dateObj.toLocaleDateString('en-US', { 
			weekday: 'long', 
			month: 'long', 
			day: 'numeric' 
		});
		return `${formattedDate} at ${timeValue}`;
	}
	
	// Update hidden input fields and cart attributes whenever date/time changes
	function updateCartDateTimeAttributes() {
		const platterPicker = document.querySelector('datetime-slot-picker[data-is-platter="true"]');
		const nonPlatterPicker = document.querySelector('datetime-slot-picker[data-is-platter="false"]');
		
		const platterAttrInput = document.getElementById('platter-datetime-attr');
		const nonPlatterAttrInput = document.getElementById('non-platter-datetime-attr');
		
		let attributes = {};
		
		// Get platter date and time
		if (platterPicker) {
			const platterDateInput = platterPicker.querySelector('#platter-date');
			const platterTimeSelect = platterPicker.querySelector('#platter-time');
			const platterDate = platterDateInput?.value;
			const platterTime = platterTimeSelect?.selectedOptions[0]?.text || platterTimeSelect?.value;
			
			if (platterDate && platterTime) {
				const formattedDateTime = formatDateTime(platterDate, platterTime);
				if (formattedDateTime && platterAttrInput) {
					platterAttrInput.value = formattedDateTime;
					attributes['Pre-Orders Pickup Date'] = formattedDateTime;
				}
			} else if (platterAttrInput) {
				platterAttrInput.value = '';
			}
		}
		
		// Get non-platter date and time
		if (nonPlatterPicker) {
			const nonPlatterDateInput = nonPlatterPicker.querySelector('#non-platter-date');
			const nonPlatterTimeSelect = nonPlatterPicker.querySelector('#non-platter-time');
			const nonPlatterDate = nonPlatterDateInput?.value;
			const nonPlatterTime = nonPlatterTimeSelect?.selectedOptions[0]?.text || nonPlatterTimeSelect?.value;
			
			if (nonPlatterDate && nonPlatterTime) {
				const formattedDateTime = formatDateTime(nonPlatterDate, nonPlatterTime);
				if (formattedDateTime && nonPlatterAttrInput) {
					nonPlatterAttrInput.value = formattedDateTime;
					attributes['Click and Collect Pickup Date'] = formattedDateTime;
				}
			} else if (nonPlatterAttrInput) {
				nonPlatterAttrInput.value = '';
			}
		}
		
		// Update cart attributes via API whenever they change (not just on checkout)
		if (Object.keys(attributes).length > 0) {
			const updateData = { attributes: attributes };
			
			fetch(`${KROWN.settings.routes.cart_update_url}`, {
				method: 'POST',
				headers: { 
					'Content-Type': 'application/json', 
					'Accept': 'application/json'
				},
				body: JSON.stringify(updateData)
			}).catch((error) => {
				console.warn('Error updating cart attributes:', error);
			});
		}
	}
	
	// Handle checkout - ensure attributes are saved before redirecting
	document.addEventListener('DOMContentLoaded', function() {
		const checkoutButton = document.querySelector('button[type="submit"][name="checkout"]');
		const cartForm = document.querySelector('form#cart');
		
		if (!cartForm) {
			console.warn('Cart form not found');
			return;
		}
		
		// Watch for date/time changes and update attributes immediately
		const platterPicker = document.querySelector('datetime-slot-picker[data-is-platter="true"]');
		const nonPlatterPicker = document.querySelector('datetime-slot-picker[data-is-platter="false"]');
		
		// Listen for changes on date inputs and time selects
		function setupDateTimeListeners() {
			if (platterPicker) {
				const platterDateInput = platterPicker.querySelector('#platter-date');
				const platterTimeSelect = platterPicker.querySelector('#platter-time');
				if (platterDateInput) {
					platterDateInput.addEventListener('change', updateCartDateTimeAttributes);
				}
				if (platterTimeSelect) {
					platterTimeSelect.addEventListener('change', updateCartDateTimeAttributes);
				}
			}
			
			if (nonPlatterPicker) {
				const nonPlatterDateInput = nonPlatterPicker.querySelector('#non-platter-date');
				const nonPlatterTimeSelect = nonPlatterPicker.querySelector('#non-platter-time');
				if (nonPlatterDateInput) {
					nonPlatterDateInput.addEventListener('change', updateCartDateTimeAttributes);
				}
				if (nonPlatterTimeSelect) {
					nonPlatterTimeSelect.addEventListener('change', updateCartDateTimeAttributes);
				}
			}
		}
		
		// Setup listeners after a short delay to ensure datetime-slot-picker is initialized
		setTimeout(setupDateTimeListeners, 500);
		
		// Also watch for changes using MutationObserver in case elements are added dynamically
		const observer = new MutationObserver(function() {
			setupDateTimeListeners();
		});
		
		if (platterPicker) {
			observer.observe(platterPicker, { childList: true, subtree: true });
		}
		if (nonPlatterPicker) {
			observer.observe(nonPlatterPicker, { childList: true, subtree: true });
		}
		
		// On form submit, ensure attributes are up to date and wait for API update before redirecting
		if (checkoutButton && cartForm) {
			cartForm.addEventListener('submit', function(e) {
				// Check if this is a checkout submission
				const isCheckout = (e.submitter && e.submitter.name === 'checkout') || 
								  (checkoutButton && document.activeElement === checkoutButton);
				
				if (isCheckout) {
					// Update attributes one final time before checkout
					updateCartDateTimeAttributes();
					
					// Get the current attribute values
					const platterAttrInput = document.getElementById('platter-datetime-attr');
					const nonPlatterAttrInput = document.getElementById('non-platter-datetime-attr');
					
					let attributes = {};
					if (platterAttrInput && platterAttrInput.value) {
						attributes['Pre-Orders Pickup Date'] = platterAttrInput.value;
					}
					if (nonPlatterAttrInput && nonPlatterAttrInput.value) {
						attributes['Click and Collect Pickup Date'] = nonPlatterAttrInput.value;
					}
					
					// If we have attributes, update via API and wait before redirecting
					if (Object.keys(attributes).length > 0) {
						e.preventDefault();
						
						// Retry function to handle 409 conflicts
						const updateCartWithRetry = (retries = 3, delay = 500) => {
							const updateData = { attributes: attributes };
							
							fetch(`${KROWN.settings.routes.cart_update_url}`, {
								method: 'POST',
								headers: { 
									'Content-Type': 'application/json', 
									'Accept': 'application/json'
								},
								body: JSON.stringify(updateData)
							}).then((response) => {
								if (response.ok) {
									// Wait a bit to ensure the update is processed, then redirect
									setTimeout(() => {
										window.location.href = '/checkout';
									}, 200);
								} else if (response.status === 409 && retries > 0) {
									// 409 Conflict - retry after delay (PickEasy might be updating)
									console.warn('Cart update conflict, retrying...', retries);
									setTimeout(() => updateCartWithRetry(retries - 1, delay), delay);
								} else {
									console.error('Error updating cart:', response.statusText);
									// Still redirect to checkout even if update fails
									window.location.href = '/checkout';
								}
							}).catch((error) => {
								if (retries > 0) {
									console.warn('Cart update error, retrying...', retries);
									setTimeout(() => updateCartWithRetry(retries - 1, delay), delay);
								} else {
									console.error('Error updating cart:', error);
									// Still redirect to checkout even if update fails
									window.location.href = '/checkout';
								}
							});
						};
						
						updateCartWithRetry();
					}
				}
			});
		}
	});

	// Hide only the "When would you like to get this order?" date picker in cart subtotal widget
	function hidePickupDateField() {
		const subtotalWidget = document.querySelector('.cart__subtotal-widget');
		if (!subtotalWidget) return;

		// Find labels containing "When would you like" text
		const labels = subtotalWidget.querySelectorAll('label');
		labels.forEach(function(label) {
			const labelText = label.textContent || '';
			if (labelText.toLowerCase().includes('when would you like to get this order') ||
				labelText.toLowerCase().includes('when would you like')) {
				// Hide only the form field container, not the whole widget
				const formField = label.closest('.form-field');
				if (formField) {
					formField.style.display = 'none';
				} else {
					// If no form-field wrapper, just hide the label and its associated input
					label.style.display = 'none';
					const associatedInput = document.querySelector('input[id="' + label.getAttribute('for') + '"]');
					if (associatedInput) {
						associatedInput.style.display = 'none';
					}
				}
			}
		});

		// Hide any date inputs in subtotal widget that aren't our datetime-slot-picker
		const dateInputs = subtotalWidget.querySelectorAll('input[type="date"]');
		dateInputs.forEach(function(input) {
			if (input.id !== 'platter-date' && input.id !== 'non-platter-date') {
				const formField = input.closest('.form-field');
				if (formField) {
					formField.style.display = 'none';
				} else {
					input.style.display = 'none';
				}
			}
		});
	}

	// Run immediately and also on DOMContentLoaded
	hidePickupDateField();
	document.addEventListener('DOMContentLoaded', hidePickupDateField);

	// Watch for dynamically added elements only in subtotal widget
	const observer = new MutationObserver(function(mutations) {
		hidePickupDateField();
	});

	// Start observing when DOM is ready
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', function() {
			const subtotalWidget = document.querySelector('.cart__subtotal-widget');
			if (subtotalWidget) {
				observer.observe(subtotalWidget, {
					childList: true,
					subtree: true
				});
			}
		});
	} else {
		const subtotalWidget = document.querySelector('.cart__subtotal-widget');
		if (subtotalWidget) {
			observer.observe(subtotalWidget, {
				childList: true,
				subtree: true
			});
		}
	}
</script>
